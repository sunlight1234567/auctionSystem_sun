# 在线拍卖系统 - 数据库设计文档

根据项目企划书及系统需求，本项目的数据库设计采用关系型数据库（本项目默认使用 SQLite，可无缝迁移至 MySQL）。以下是详细的数据模型设计。

## 1. 实体关系图 (ERD) 简述

系统主要包含以下核心实体：
- **User (用户)**: 包含买家、卖家和管理员信息。
- **Item (拍品)**: 拍卖的商品信息，关联卖家和最终中标者。
- **Bid (出价)**: 记录每一次竞价行为，关联用户和拍品。
- **ItemImage (拍品图片)**: 拍品的多张展示图片（一对多关系）。
- **Post (帖子)**: 用户发布的论坛/社区帖子。
- **ChatSession (聊天会话)**: 买家与卖家针对特定拍品的私信会话。
- **Message (聊天消息)**: 会话中的具体消息记录。
- **Appeal (申诉)**: 卖家针对拍品下架等问题的申诉记录。

## 2. 数据表详情

### 2.1 用户表 (`users`)
存储所有系统用户的登录信息及角色。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 用户唯一标识 |
| `username` | VARCHAR(80) | UNIQUE, NOT NULL | 登录用户名 |
| `password_hash` | VARCHAR(128)| NOT NULL |加密后的密码 |
| `role` | VARCHAR(20) | NOT NULL | 角色枚举：`buyer` (买家), `seller` (卖家), `admin` (管理员) |
| `phone` | VARCHAR(20) | NULLABLE | 联系电话 |
| `avatar` | VARCHAR(200)| NULLABLE | 用户头像文件名 |
| `banned_until` | DATETIME | NULLABLE | 封禁截止时间 |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 注册时间 |

### 2.2 拍品表 (`items`)
存储拍卖商品的核心信息及当前状态。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 拍品唯一标识 |
| `seller_id` | INT | FOREIGN KEY (users.id) | 卖家ID |
| `name` | VARCHAR(100)| NOT NULL | 商品标题 |
| `description` | TEXT | NULLABLE | 商品详细描述 |
| `start_price` | DECIMAL(10,2)| NOT NULL | 起拍价 |
| `current_price`| DECIMAL(10,2)| NOT NULL | 当前最高价（初始等于起拍价） |
| `increment` | DECIMAL(10,2)| DEFAULT 10.00 | 最小加价幅度 |
| `start_time` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 实际上架/开拍时间 |
| `end_time` | DATETIME | NOT NULL | 预计结束时间（支持延时） |
| `status` | VARCHAR(20) | DEFAULT 'pending' | 状态：`pending`, `active`, `rejected`, `ended` |
| `rejection_reason`| VARCHAR(255)| NULLABLE | 审核驳回理由 |
| `appeal_reason` | TEXT | NULLABLE | 申诉理由 |
| `appeal_status` | VARCHAR(20) | NULLABLE | 申诉状态：`pending`, `resolved`, `rejected` |
| `highest_bidder_id` | INT | FOREIGN KEY (users.id) | 当前最高出价者ID |
| `order_hash` | VARCHAR(64) | NULLABLE | 订单哈希 |
| `payment_status` | VARCHAR(20) | DEFAULT 'unpaid' | 支付状态：`unpaid`, `paid` |
| `tracking_number` | VARCHAR(100)| NULLABLE | 快递单号 |
| `shipping_status` | VARCHAR(20) | DEFAULT 'unshipped' | 物流状态：`unshipped`, `shipped`, `received` |
| `shipping_name` | VARCHAR(80) | NULLABLE | 收货人姓名 |
| `shipping_phone` | VARCHAR(20) | NULLABLE | 收货人电话 |
| `shipping_address`| VARCHAR(255)| NULLABLE | 收货地址 |

### 2.3 出价记录表 (`bids`)
记录拍卖过程中的流水，用于历史回溯及防止纠纷。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 出价记录ID |
| `item_id` | INT | FOREIGN KEY (items.id) | 关联拍品 |
| `user_id` | INT | FOREIGN KEY (users.id) | 出价人 |
| `amount` | DECIMAL(10,2)| NOT NULL | 出价金额 |
| `timestamp` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 出价时间 |

### 2.5 帖子表 (`posts`)
社区论坛帖子。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 帖子ID |
| `user_id` | INT | FOREIGN KEY (users.id) | 发帖人ID |
| `content` | TEXT | NOT NULL | 帖子内容 |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 发布时间 |

### 2.6 聊天会话表 (`chat_sessions`)
买卖双方针对拍品的私信会话。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 会话ID |
| `item_id` | INT | FOREIGN KEY (items.id) | 关联拍品ID |
| `buyer_id` | INT | FOREIGN KEY (users.id) | 买家ID |
| `seller_id` | INT | FOREIGN KEY (users.id) | 卖家ID |
| `last_message` | VARCHAR(255)| NULLABLE | 最后一条
7.  **User (1) -> (N) Post**: 一个用户可以发布多条帖子。
8.  **Item (1) -> (N) ChatSession**: 围绕一个拍品可以有多个买家的咨询会话。
9.  **ChatSession (1) -> (N) Message**: 一个会话包含多条消息。
10. **Item (1) -> (N) Appeal**: 一个拍品可能有多次申诉记录。消息预览 |
| `updated_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 更新时间 |
| `buyer_unread` | INT | DEFAULT 0 | 买家未读数 |
| `seller_unread` | INT | DEFAULT 0 | 卖家未读数 |

### 2.7 聊天消息表 (`messages`)
会话具体消息内容。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 消息ID |
| `chat_session_id`| INT | FOREIGN KEY (chat_sessions.id)| 关联会话ID |
| `sender_id` | INT | FOREIGN KEY (users.id) | 发送者ID |
| `content` | TEXT | NOT NULL | 消息内容 |
| `timestamp` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 发送时间 |

### 2.8 申诉表 (`appeals`)
卖家对被驳回或下架拍品的申诉。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 申诉ID |
| `item_id` | INT | FOREIGN KEY (items.id) | 关联拍品ID |
| `user_id` | INT | FOREIGN KEY (users.id) | 申诉人ID |
| `content` | TEXT | NOT NULL | 申诉理由详情 |
| `status` | VARCHAR(20) | DEFAULT 'pending' | 状态：`pending`, `approved`, `rejected` |
| `rejection_reason_snapshot` | VARCHAR(255) | NULLABLE | 申诉时的原驳回理由快照 |
| `admin_reply` | TEXT | NULLABLE | 管理员回复 |
| `created_at` | DATETIME | DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| `handled_at` | DATETIME | NULLABLE | 处理时间 |

### 2.4 拍品图片表 (`item_images`)
支持一个拍品对应多张图片。

| 字段名 | 类型 | 约束 | 说明 |
| :--- | :--- | :--- | :--- |
| `id` | INT | PRIMARY KEY, AUTO_INCREMENT | 图片ID |
| `item_id` | INT | FOREIGN KEY (items.id) | 关联拍品 |
| `image_url` | VARCHAR(255)| NOT NULL | 图片存储路径或URL |
| `is_primary` | BOOLEAN | DEFAULT FALSE | 是否为主图（封面图） |

---

## 3. 关联关系说明

1.  **User (1) -> (N) Item**: 一个卖家可以发布多个拍品。
2.  **Item (1) -> (1) User**: 一个拍品属于一个卖家。
3.  **User (1) -> (N) Bid**: 一个买家可以进行多次出价。
4.  **Item (1) -> (N) Bid**: 一个拍品拥有多条出价记录。
5.  **Item (1) -> (1) User (highest_bidder)**: 一个拍品当前只有一个最高出价者。
6.  **Item (1) -> (N) ItemImage**: 一个拍品包含多张展示图片。

## 4. 索引优化建议

为了提高查询性能，建议在以下字段建立索引：
- `items.status`: 频繁查询“正在进行”的拍卖 (`WHERE status = 'active'`)。
- `items.end_time`: 后台定时任务频繁通过时间判断拍卖是否结束。
- `bids.item_id`: 详情页加载出价历史时使用。
