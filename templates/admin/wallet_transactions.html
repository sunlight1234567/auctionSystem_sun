{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-md-12">
    <h1>后台管理</h1>
  </div>
</div>

{% include "admin/nav_tabs.html" %}

<div class="tab-content mt-3">
  <h3 class="mb-3">用户资金明细</h3>

  <form class="row g-3 mb-3" method="get">
    <div class="col-md-3">
      <label class="form-label">用户（用户名或ID）</label>
      <input type="text" class="form-control" name="user" value="{{ f_user }}" placeholder="如: alice 或 12">
    </div>
    <div class="col-md-2">
      <label class="form-label">类型</label>
      <select class="form-select" name="type">
        <option value="" {{ '' == f_type and 'selected' or '' }}>全部</option>
        <option value="recharge" {{ 'recharge' == f_type and 'selected' or '' }}>充值</option>
        <option value="deposit" {{ 'deposit' == f_type and 'selected' or '' }}>保证金</option>
        <option value="refund" {{ 'refund' == f_type and 'selected' or '' }}>退款</option>
        <option value="payment" {{ 'payment' == f_type and 'selected' or '' }}>支付</option>
        <option value="forfeit" {{ 'forfeit' == f_type and 'selected' or '' }}>没收</option>
        <option value="payout" {{ 'payout' == f_type and 'selected' or '' }}>入账</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">开始日期</label>
      <input type="date" class="form-control" name="start" value="{{ f_start }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">结束日期</label>
      <input type="date" class="form-control" name="end" value="{{ f_end }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">每页</label>
      <select class="form-select" name="per_page">
        <option value="20" {{ per_page == 20 and 'selected' or '' }}>20</option>
        <option value="50" {{ per_page == 50 and 'selected' or '' }}>50</option>
        <option value="100" {{ per_page == 100 and 'selected' or '' }}>100</option>
      </select>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <button class="btn btn-primary w-100" type="submit">筛选</button>
    </div>
    <div class="col-md-1 d-flex align-items-end">
      <a class="btn btn-outline-secondary w-100" href="{{ url_for('admin_wallet_transactions') }}">重置</a>
    </div>
  </form>

  <div class="mb-2 text-muted">
    共 {{ total }} 条记录；第 {{ page }} / {{ pages }} 页
  </div>
  <div class="table-responsive">
    <table class="table table-sm table-striped">
      <thead>
        <tr>
          <th>时间</th>
          <th>用户</th>
          <th>类型</th>
          <th>收支</th>
          <th>金额</th>
          <th>余额</th>
          <th>拍品</th>
          <th>说明</th>
        </tr>
      </thead>
      <tbody>
        {% for tx in transactions %}
        <tr>
          <td>{{ tx.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
          <td>{{ tx.user.username }}</td>
          <td><span class="badge {{ wallet_type_badge(tx.type) }}">{{ wallet_type_label(tx.type) }}</span></td>
          <td><span class="badge {{ tx.direction == 'credit' and 'bg-success' or 'bg-danger' }}">{{ wallet_direction_label(tx.direction) }}</span></td>
          <td class="{{ tx.direction == 'credit' and 'text-success' or 'text-danger' }}">{{ tx.direction == 'credit' and '+' or '-' }}¥{{ tx.amount }}</td>
          <td>¥{{ tx.balance_after }}</td>
          <td>{% if tx.item %}<a href="{{ url_for('item_detail', item_id=tx.item.id) }}">{{ tx.item.name }}</a>{% else %}-{% endif %}</td>
          <td>{{ tx.description or '-' }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <nav aria-label="Page navigation" class="mt-3">
    <ul class="pagination">
      <li class="page-item {{ not has_prev and 'disabled' or '' }}">
        <a class="page-link" href="{{ url_for('admin_wallet_transactions', user=f_user, type=f_type, start=f_start, end=f_end, per_page=per_page, page=page-1) }}">上一页</a>
      </li>
      <li class="page-item {{ not has_next and 'disabled' or '' }}">
        <a class="page-link" href="{{ url_for('admin_wallet_transactions', user=f_user, type=f_type, start=f_start, end=f_end, per_page=per_page, page=page+1) }}">下一页</a>
      </li>
    </ul>
  </nav>
</div>
{% endblock %}
