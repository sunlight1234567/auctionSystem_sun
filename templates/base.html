<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线拍卖系统</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { padding-top: 60px; }
        .footer { margin-top: 50px; padding: 20px 0; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">在线拍卖</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">首页</a>
                    </li>
                    {% if current_user.is_authenticated and current_user.role == 'seller' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('publish') }}">发布拍品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('my_auctions') }}">我的拍品</a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.role == 'buyer' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('my_orders') }}">我的订单</a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.role == 'admin' %}
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="{{ url_for('admin_dashboard') }}">
                            后台管理
                            {% if pending_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ pending_count }}
                                <span class="visually-hidden">unread messages</span>
                            </span>
                            {% endif %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav align-items-center">
                    {% if current_user.is_authenticated %}
                    <li class="nav-item me-3">
                        <a href="{{ url_for('inbox') }}" class="nav-link position-relative text-light" title="收件箱">
                            <i class="bi bi-chat-text-fill" style="font-size: 1.2rem;"></i>
                            <span id="inbox-badge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle {{ 'd-none' if unread_chats_count == 0 else '' }}">
                                <span class="visually-hidden">New alerts</span>
                            </span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('user_profile', user_id=current_user.id) }}" class="nav-link text-light d-flex align-items-center">
                            {% if current_user.avatar %}
                            <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}" class="rounded-circle me-2" style="width: 28px; height: 28px; object-fit: cover; border: 1px solid rgba(255,255,255,0.5);">
                            {% else %}
                            <i class="bi bi-person-circle me-2"></i>
                            {% endif %}
                            欢迎, {{ current_user.username }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">退出</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">登录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('register') }}">注册</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">© 2026 在线拍卖系统项目</span>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        
        <!-- Admin Notification Toast -->
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <div id="adminToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header bg-danger text-white">
              <strong class="me-auto">待办事项提醒</strong>
              <small>系统消息</small>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="adminToastBody">
               当前有 <strong>{{ pending_count }}</strong> 个拍品等待审核。
               <div class="mt-2 pt-2 border-top">
                   <a href="{{ url_for('admin_dashboard') }}" class="btn btn-sm btn-light text-dark fw-bold w-100">立即处理</a>
               </div>
            </div>
          </div>
        {% endif %}

        <!-- General Notification Toast -->
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <strong class="me-auto">通知</strong>
                <small class="text-white-50">刚刚</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="notificationBody">
                <!-- Content injected by JS -->
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}
    <script>
        var socket = io();
        socket.on('connect', function() {
             socket.emit('join_check', {});
        });
        
        // 如果有pending_count且大于0，按逻辑显示Toast
        {% if current_user.is_authenticated and current_user.role == 'admin' and pending_count > 0 %}
        document.addEventListener('DOMContentLoaded', function() {
            var toastEl = document.getElementById('adminToast');
            if (toastEl) {
                var currentCount = {{ pending_count }};
                var dismissedKey = 'admin_toast_dismissed_count';
                var lastDismissed = parseInt(localStorage.getItem(dismissedKey) || 0);

                // 逻辑：
                // 1. 如果当前数量 > 上次关闭时的数量 ==> 有新增，显示
                // 2. 如果当前数量 < 上次关闭时的数量 ==> 处理了部分，重置基准，但不用显示（因为是减少）
                // 3. 如果相等 ==> 关闭过，不再显示
                
                if (currentCount < lastDismissed) {
                    // 状态重置：如果数量减少了（如审核通过了），更新基准，避免下次新增时无法触发 (e.g. 5->3, set 3. new item->4. 4>3 show)
                    localStorage.setItem(dismissedKey, currentCount);
                } else if (currentCount > lastDismissed) {
                    // 有新增，显示
                    var toast = new bootstrap.Toast(toastEl);
                    toast.show();
                }

                // 监听手动关闭事件
                toastEl.addEventListener('hidden.bs.toast', function () {
                    // 关闭时，记录当前已知数量
                    localStorage.setItem(dismissedKey, currentCount);
                });
            }
        });
        {% endif %}
        
        // 监听新私信通知
        socket.on('new_chat_notification', function(data) {
            // 更新红点（如果有）
            var badge = document.getElementById('inbox-badge');
            if(badge) {
                badge.classList.remove('d-none');
            }
            
            // 显示 Toast
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Reset styling to primary (blue)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-primary text-white';
                
                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "新消息提醒";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // 监听拍卖被批准通知
        socket.on('auction_approved', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to success (green)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-success text-white';

                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "审核通过";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // 全局监听管理员通知
        socket.on('new_pending_item', function(data) {
            var toastEl = document.getElementById('adminToast');
            if (toastEl) {
                document.getElementById('adminToastBody').innerHTML = data.msg + 
                '<div class="mt-2 pt-2 border-top">' + 
                '<a href="{{ url_for("admin_dashboard") }}" class="btn btn-sm btn-light text-dark fw-bold w-100">立即处理</a>' + 
                '</div>';
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // 监听拍卖被拒绝通知
        socket.on('auction_rejected', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to danger (red) or keep warning based on preference, but usually rejection is substantial
                // Let's stick to user request logic context: if they wanted green for success, maybe keep blue or separate color for reject?
                // User asked for green for success. Rejection was not explicitly told to change color, but previously I made notificationToast primary(blue).
                // Let's set it to original warning (yellow) or danger (red) to distinguish?
                // User said "Previously it was yellow for reject". I changed basic notificationToast to blue. 
                // So now I should probably dynamically set color.
                
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-warning text-dark'; // Back to yellow for rejection
                
                document.getElementById('notificationBody').innerText = data.msg;
                // 将标题改为“申请被拒绝”或其他相关提示
                var headerEl = toastEl.querySelector('.toast-header strong');
                if(headerEl) headerEl.innerText = "申请被拒绝";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // 监听拍卖结果通知 (通用)
        socket.on('auction_result_toast', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                var headerEl = toastEl.querySelector('.toast-header');
                var titleEl = toastEl.querySelector('.toast-header strong');
                
                // 根据类型设置颜色
                if (data.type === 'success') { // 中标
                    headerEl.className = 'toast-header bg-success text-white';
                    if(titleEl) titleEl.innerText = "中标通知";
                } else if (data.type === 'info') { // 卖家通知
                    headerEl.className = 'toast-header bg-primary text-white';
                    if(titleEl) titleEl.innerText = "拍卖结果";
                } else if (data.type === 'warning') { // 未中标
                    headerEl.className = 'toast-header bg-warning text-dark';
                    if(titleEl) titleEl.innerText = "拍卖结果";
                } else {
                    headerEl.className = 'toast-header bg-secondary text-white';
                }

                document.getElementById('notificationBody').innerText = data.msg;
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
    {% endblock %}
</body>
</html>
