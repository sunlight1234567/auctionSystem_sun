<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>在线拍卖系统</title>
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='logo.svg') }}">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <!-- Socket.IO -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body { padding-top: 60px; }
        .footer { margin-top: 50px; padding: 20px 0; background-color: #f8f9fa; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <img src="{{ url_for('static', filename='Allction.png') }}" alt="Allction" style="height: 40px; width: auto;">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">首页</a>
                    </li>
                    {% if current_user.is_authenticated and current_user.role != 'admin' and not current_user.is_verified %}
                    <li class="nav-item">
                        <a class="nav-link text-primary fw-semibold" href="{{ url_for('verify_identity') }}">
                            <i class="bi bi-shield-check"></i> 完成实名认证
                        </a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.role == 'seller' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('publish') }}">发布拍品</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('my_auctions') }}">我的拍品</a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.role == 'buyer' %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('my_orders') }}">我的订单</a>
                    </li>
                    {% endif %}
                    {% if current_user.is_authenticated and current_user.role == 'admin' %}
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="{{ url_for('admin_dashboard') }}">
                            后台管理
                            {% if pending_count > 0 %}
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                {{ pending_count }}
                                <span class="visually-hidden">unread messages</span>
                            </span>
                            {% endif %}
                        </a>
                    </li>
                    {% endif %}
                </ul>
                <ul class="navbar-nav align-items-center">
                    {% if current_user.is_authenticated %}
                    {% if current_user.role != 'admin' %}
                    <li class="nav-item me-3">
                        <a href="{{ url_for('wallet') }}" class="nav-link text-light" title="我的钱包">
                            <i class="bi bi-wallet2" style="font-size: 1.1rem;"></i> 钱包
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item me-3">
                        <a href="{{ url_for('inbox') }}" class="nav-link position-relative text-light" title="收件箱">
                            <i class="bi bi-chat-text-fill" style="font-size: 1.2rem;"></i>
                            <span id="inbox-badge" class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle {{ 'd-none' if unread_chats_count == 0 else '' }}">
                                <span class="visually-hidden">New alerts</span>
                            </span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="{{ url_for('user_profile', user_id=current_user.id) }}" class="nav-link text-light d-flex align-items-center">
                            {% if current_user.avatar %}
                            <img src="{{ url_for('static', filename='uploads/' + current_user.avatar) }}" class="rounded-circle me-2" style="width: 28px; height: 28px; object-fit: cover; border: 1px solid rgba(255,255,255,0.5);">
                            {% else %}
                            <i class="bi bi-person-circle me-2"></i>
                            {% endif %}
                            欢迎, {{ current_user.username }}
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">退出</a>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('login') }}">登录</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('register') }}">注册</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                {{ message|safe }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        {% endif %}
        {% endwith %}

        {% block content %}{% endblock %}
    </div>

    <footer class="footer text-center">
        <div class="container">
            <span class="text-muted">© 2026 在线拍卖系统项目</span>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 11">
        
        <!-- Admin Notification Toast -->
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
          <div id="adminToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="false">
            <div class="toast-header bg-danger text-white">
              <strong class="me-auto">待办事项提醒</strong>
              <small>系统消息</small>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="adminToastBody">
               当前有 <strong>{{ pending_count|default(0) }}</strong> 个待处理事项(审核/申诉)。
               <div class="mt-2 pt-2 border-top">
                   <a href="{{ url_for('admin_audit') }}" class="btn btn-sm btn-light text-dark fw-bold w-100">前往审核</a>
                   <a href="{{ url_for('admin_appeals') }}" class="btn btn-sm btn-secondary text-white fw-bold w-100 mt-1">处理申诉</a>
               </div>
            </div>
          </div>
        {% endif %}

        <!-- General Notification Toast -->
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-primary text-white">
                <strong class="me-auto">通知</strong>
                <small class="text-white-50">刚刚</small>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="notificationBody">
                <!-- Content injected by JS -->
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}
    <script>
        var socket = io();
        socket.on('connect', function() {
             socket.emit('join_check', {});
        });
        
        // 如果有pending_count且大于0，按逻辑显示Toast
        {% if current_user.is_authenticated and current_user.role == 'admin' %}
        document.addEventListener('DOMContentLoaded', function() {
            var toastEl = document.getElementById('adminToast');
            if (toastEl) {
                var currentCount = {{ pending_count|default(0) }};
                if (currentCount > 0) {
                    var dismissedKey = 'admin_toast_dismissed_count';
                    var lastDismissed = parseInt(localStorage.getItem(dismissedKey) || 0);

                    // 逻辑：
                    // 1. 如果当前数量 > 上次关闭时的数量 ==> 有新增，显示
                    // 2. 如果当前数量 < 上次关闭时的数量 ==> 处理了部分，重置基准，但不用显示（因为是减少）
                    // 3. 如果相等 ==> 关闭过，不再显示
                    
                    if (currentCount < lastDismissed) {
                        // 状态重置：如果数量减少了（如审核通过了），更新基准，避免下次新增时无法触发 (e.g. 5->3, set 3. new item->4. 4>3 show)
                        localStorage.setItem(dismissedKey, currentCount);
                    } else if (currentCount > lastDismissed) {
                        // 有新增，显示
                        var toast = new bootstrap.Toast(toastEl);
                        toast.show();
                    }

                    // 监听手动关闭事件
                    toastEl.addEventListener('hidden.bs.toast', function () {
                        // 关闭时，记录当前已知数量
                        localStorage.setItem(dismissedKey, currentCount);
                    });
                }
            }
        });
        {% endif %}
        
        // 监听新待办事项（审核/申诉）
        socket.on('new_pending_item', function(data) {
            {% if current_user.is_authenticated and current_user.role == 'admin' %}
            var toastEl = document.getElementById('adminToast');
            if (toastEl) {
                var targetUrl = "{{ url_for('admin_audit') }}";
                var btnClass = "btn-light text-dark";
                var btnText = "立即审核";

                if (data.type === 'appeal') {
                    targetUrl = "{{ url_for('admin_appeals') }}";
                     btnClass = "btn-warning text-dark";
                     btnText = "处理申诉";
                }

                // Update content to show the real-time message
                document.getElementById('adminToastBody').innerHTML = data.msg + 
                   '<div class="mt-2 pt-2 border-top">' +
                   '<a href="' + targetUrl + '" class="btn btn-sm ' + btnClass + ' fw-bold w-100">' + btnText + '</a></div>';
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
            {% endif %}
        });
        
        // 监听新私信通知
        socket.on('new_chat_notification', function(data) {
            // 更新红点（如果有）
            var badge = document.getElementById('inbox-badge');
            if(badge) {
                badge.classList.remove('d-none');
            }
            
            // 显示 Toast
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Reset styling to primary (blue)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-primary text-white';
                
                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "新消息提醒";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });

        // 监听拍卖被批准通知
        socket.on('auction_approved', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to success (green)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-success text-white';
                
                // 更换关闭按钮样式
                var closeBtn = headerEl.querySelector('.btn-close');
                closeBtn.className = 'btn-close btn-close-white';

                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "审核通过";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
                
                // 延迟刷新页面以更新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        });

        // 监听拍卖被拒绝通知
        socket.on('auction_rejected', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to warning (yellow)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-warning text-dark';
                
                // 黄色背景通常配黑色文字，关闭按钮不需要白色滤镜
                var closeBtn = headerEl.querySelector('.btn-close');
                closeBtn.className = 'btn-close';

                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "审核拒绝";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
                
                // 延迟刷新页面以更新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        });

        // 监听拍卖被强制停止通知
        socket.on('auction_stopped', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to warning (yellow)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-warning text-dark';
                
                var closeBtn = headerEl.querySelector('.btn-close');
                closeBtn.className = 'btn-close';

                // 使用 innerHTML 支持超链接
                document.getElementById('notificationBody').innerHTML = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "拍品下架";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
                
                // 延迟刷新页面以更新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        });

        // 监听拍卖被恢复通知
        socket.on('auction_restored', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                // Change styling to success (green)
                var headerEl = toastEl.querySelector('.toast-header');
                headerEl.className = 'toast-header bg-success text-white';
                
                var closeBtn = headerEl.querySelector('.btn-close');
                closeBtn.className = 'btn-close btn-close-white';

                document.getElementById('notificationBody').innerText = data.msg;
                var titleEl = toastEl.querySelector('.toast-header strong');
                if(titleEl) titleEl.innerText = "拍卖恢复";
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
                
                // 延迟刷新页面以更新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            }
        });

        // 监听拍卖结果通知 (通用)
        socket.on('auction_result_toast', function(data) {
            var toastEl = document.getElementById('notificationToast');
            if (toastEl) {
                var headerEl = toastEl.querySelector('.toast-header');
                var titleEl = toastEl.querySelector('.toast-header strong');
                
                // 根据类型设置颜色
                if (data.type === 'success') { // 中标
                    headerEl.className = 'toast-header bg-success text-white';
                    if(titleEl) titleEl.innerText = "中标通知";
                } else if (data.type === 'info') { // 卖家通知
                    headerEl.className = 'toast-header bg-primary text-white';
                    if(titleEl) titleEl.innerText = "拍卖结果";
                } else if (data.type === 'warning') { // 未中标
                    headerEl.className = 'toast-header bg-warning text-dark';
                    if(titleEl) titleEl.innerText = "拍卖结果";
                } else {
                    headerEl.className = 'toast-header bg-secondary text-white';
                }

                document.getElementById('notificationBody').innerText = data.msg;
                
                var toast = new bootstrap.Toast(toastEl);
                toast.show();
            }
        });
    </script>
    {% endblock %}
</body>
</html>
