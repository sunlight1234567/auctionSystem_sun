{% extends "base.html" %}

{% block content %}

{% if current_user.is_authenticated and current_user.role != 'admin' and not current_user.is_verified %}
<div class="alert alert-primary sticky-top" role="alert" style="z-index: 10;">
    <div class="d-flex justify-content-between align-items-center">
        <div class="me-3">
            <i class="bi bi-shield-check"></i>
            为保障交易安全，请完成实名认证。完成后即可参与出价、聊天与交易。
        </div>
        <div>
            <a href="{{ url_for('verify_identity') }}" class="btn btn-sm btn-light text-primary fw-semibold">立即前往</a>
        </div>
    </div>
    <div class="small text-muted mt-1">提示：未认证用户仅可浏览首页商品。</div>
    <style>
        .sticky-top { top: 60px; }
    </style>
    </div>
{% endif %}

<div class="row mb-4">
    <div class="col-md-8 offset-md-2">
        <form action="{{ url_for('index') }}" method="GET" class="d-flex">
            <input class="form-control me-2" type="search" name="q" placeholder="搜索商品名称或卖家..." aria-label="Search" value="{{ search_query }}">
            <button class="btn btn-outline-success" type="submit">搜索</button>
            {% if search_query %}
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary ms-2" title="清除搜索">重置</a>
            {% endif %}
        </form>
    </div>
</div>

{% if search_query %}
<div class="alert alert-light border mb-4">
    <i class="bi bi-search"></i> 搜索结果: "{{ search_query }}" 
    {% if not active_items and not upcoming_items and not ended_items and not matched_sellers %}
    <span class="text-muted ms-2">(未找到相关结果)</span>
    {% endif %}
</div>

{% if matched_sellers %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">找到的卖家</div>
    <div class="list-group list-group-flush">
        {% for seller in matched_sellers %}
        <a href="{{ url_for('user_profile', user_id=seller.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                {% if seller.avatar %}
                <img src="{{ url_for('static', filename='uploads/' + seller.avatar) }}" class="rounded-circle me-2" style="width: 30px; height: 30px; object-fit: cover;">
                {% else %}
                <i class="bi bi-person-circle me-2" style="font-size: 1.2rem;"></i>
                {% endif %}
                
                <div>
                    <strong>{{ seller.username }}</strong>
                    {% if seller.phone %}
                    <span class="text-muted small ms-2"><i class="bi bi-telephone"></i> {{ seller.phone }}</span>
                    {% endif %}
                </div>
            </div>
            <span class="badge bg-primary rounded-pill">访问主页</span>
        </a>
        {% endfor %}
    </div>
</div>
{% endif %}
{% endif %}

<!-- 宏定义：用于渲染单个商品卡片 -->
{% macro render_item_card(item, type) %}
<div class="col-md-4 mb-4">
    <div class="card h-100 {{ 'border-secondary' if type == 'ended' else '' }}">
        {% if item.images and item.images|length > 0 %}
            <img src="{{ url_for('static', filename=item.images[0].image_url) }}" class="card-img-top" alt="{{ item.name }}" style="height: 200px; object-fit: cover; {{ 'filter: grayscale(100%);' if type == 'ended' else '' }}">
        {% else %}
            <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px; {{ 'filter: grayscale(100%);' if type == 'ended' else '' }}">
                暂无图片
            </div>
        {% endif %}
        
        <div class="card-body">
            <h5 class="card-title text-truncate">{{ item.name }}</h5>
            
            {% if type == 'active' %}
                <p class="card-text">
                    <strong>当前价: </strong> <span class="text-danger fw-bold fs-5">¥{{ item.current_price }}</span>
                </p>
                <div class="alert alert-light border p-1 mb-2 text-center text-danger small">
                    <i class="bi bi-clock"></i> 结束: {{ item.end_time.strftime('%m-%d %H:%M') }}
                </div>
            {% elif type == 'upcoming' %}
                <p class="card-text">
                    <strong>起拍价: </strong> <span>¥{{ item.start_price }}</span>
                </p>
                <div class="alert alert-info p-1 mb-2 text-center small">
                     开始: {{ item.start_time.strftime('%m-%d %H:%M') }}
                </div>
            {% elif type == 'ended' %}
                <p class="card-text text-muted">
                    <strong>成交价: </strong> <span>¥{{ item.current_price }}</span>
                </p>
                <div class="alert alert-secondary p-1 mb-2 text-center small">
                    已结束: {{ item.end_time.strftime('%m-%d') }}
                </div>
            {% endif %}
            
            <p class="card-text small text-muted text-truncate">{{ item.description }}</p>
        </div>
        
        <div class="card-footer bg-white border-top-0">
            {% if type == 'active' %}
                <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn btn-danger w-100">立即出价</a>
            {% elif type == 'upcoming' %}
                <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn btn-outline-primary w-100">查看详情</a>
            {% else %}
                <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn btn-secondary w-100">查看结果</a>
            {% endif %}
        </div>
    </div>
</div>
{% endmacro %}

<!-- 页面主要内容 -->

<!-- 1. 正在进行的拍卖 -->
<div class="row mb-3">
    <div class="col-12 d-flex align-items-center border-bottom pb-2">
        <h3 class="text-danger m-0">正在热拍</h3>
        <span class="badge bg-danger rounded-pill ms-2">{{ active_items|length }}</span>
    </div>
</div>
<div class="row mb-5">
    {% if active_items %}
        {% for item in active_items %}
            {{ render_item_card(item, 'active') }}
        {% endfor %}
    {% else %}
        <div class="col-12 text-center text-muted py-4">暂无正在进行的拍卖</div>
    {% endif %}
</div>

<!-- 2. 即将开始的拍卖 -->
<div class="row mb-3">
    <div class="col-12 d-flex align-items-center border-bottom pb-2">
        <h3 class="text-primary m-0">即将开始</h3>
        <span class="badge bg-primary rounded-pill ms-2">{{ upcoming_items|length }}</span>
    </div>
</div>
<div class="row mb-5">
    {% if upcoming_items %}
        {% for item in upcoming_items %}
            {{ render_item_card(item, 'upcoming') }}
        {% endfor %}
    {% else %}
        <div class="col-12 text-center text-muted py-4">暂无即将开始的排期</div>
    {% endif %}
</div>

<!-- 3. 已结束的拍卖 -->
<div class="row mb-3">
    <div class="col-12 d-flex align-items-center border-bottom pb-2">
        <h3 class="text-secondary m-0">历史拍卖</h3>
        <span class="badge bg-secondary rounded-pill ms-2">{{ ended_items|length }}</span>
    </div>
</div>
<div class="row mb-5">
    {% if ended_items %}
        {% for item in ended_items %}
            {{ render_item_card(item, 'ended') }}
        {% endfor %}
    {% else %}
        <div class="col-12 text-center text-muted py-4">暂无历史记录</div>
    {% endif %}
</div>

{% endblock %}
